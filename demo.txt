// Update Quantity
function updateQuantity(itemKey, change = 0) {
  const input = document.querySelector(`.quantity-input[data-item-key="${itemKey}"]`);

  let qty = parseInt(input.value) + change;

  if (qty < 1) qty = 1;
  if (qty > 99) qty = 99;
  input.value = qty;

  // AJAX call to Shopify cart
  fetch('/cart/change.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: itemKey, quantity: qty })
  })
  .then(res => res.json())
  .then(updateCartUI)
  .catch(err => console.error(err));
}

// Remove Item
function removeItem(itemKey) {
  fetch('/cart/change.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: itemKey, quantity: 0 })
  })
  .then(res => res.json())
  .then(updateCartUI)
  .catch(err => console.error(err));
}

// Update Cart UI
function updateCartUI(cart) {
  cart.items.forEach(item => {
    const totalEl = document.querySelector(`.items-total[data-item-key='${item.key}'] p`);
    const inputEl = document.querySelector(`.quantity-input[data-item-key='${item.key}']`);
    if(totalEl) totalEl.textContent = Shopify.formatMoney(item.line_price, "{{ shop.money_format }}");
    if(inputEl) inputEl.value = item.quantity;
  });

  // Update subtotal
  const subtotalEl = document.querySelector('.subtotal span');
  if(subtotalEl) subtotalEl.textContent = Shopify.formatMoney(cart.items_subtotal_price, "{{ shop.money_format }}");

  // Remove deleted items from DOM
  cart.items.forEach(item => {
    const row = document.querySelector(`.quantity-input[data-item-key='${item.key}']`)?.closest('tr');
    if(row) row.style.display = '';
  });

  document.querySelectorAll('.quantity-input').forEach(input => {
    const row = input.closest('tr');
    const itemKey = input.dataset.itemKey;
    const exists = cart.items.some(i => i.key === itemKey);
    if(!exists && row) row.remove();
  });

  // Show empty cart
  if(cart.item_count === 0) {
    document.querySelector('.cart-wrapper').style.display = 'none';
    document.querySelector('.empty-cart').style.display = 'flex';
  } else {
    document.querySelector('.cart-wrapper').style.display = 'block';
    document.querySelector('.empty-cart').style.display = 'none';
  }
}
